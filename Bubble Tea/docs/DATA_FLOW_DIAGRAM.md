# Data Flow Diagram - Система резервного копирования

## Level 0: Context Diagram

```
┌──────────────────┐
│  Администратор   │
│       БД         │
└────────┬─────────┘
         │
         │ Команды управления
         │ (создать/восстановить backup)
         ▼
┌─────────────────────────────────────┐
│                                     │
│   Система управления резервным      │
│      копированием БД                │
│                                     │
└────────┬─────────────────┬──────────┘
         │                 │
         │ Backup          │ Метрики/алерты
         │ файлы           │
         ▼                 ▼
┌─────────────────┐  ┌──────────────┐
│  Хранилище      │  │  Monitoring  │
│   Backup        │  │   System     │
└─────────────────┘  └──────────────┘
```

## Level 1: Main Processes

```
                      ┌──────────────────┐
                      │  Администратор   │
                      └─────────┬────────┘
                                │
                                │ 1. Запрос backup/restore
                                ▼
    ┌──────────────────────────────────────────────────────┐
    │          1.0 Управление резервным копированием        │
    │                                                       │
    │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌────────┐ │
    │  │1.1 Create│  │1.2 Store│  │1.3 Restore│ │1.4 Monitor│
    │  │ Backup  │  │ Backup  │  │ Backup  │  │ Status │ │
    │  └────┬────┘  └────┬────┘  └────┬────┘  └───┬────┘ │
    └───────┼────────────┼────────────┼────────────┼──────┘
            │            │            │            │
            │ 2. Чтение  │ 3. Запись  │ 4. Чтение  │ 5. Метрики
            │   данных   │   backup   │   backup   │
            ▼            ▼            ▼            ▼
    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
    │              │  │              │  │              │
    │  PostgreSQL  │  │  File System │  │  Prometheus  │
    │   Database   │  │   Storage    │  │   Grafana    │
    │              │  │              │  │              │
    └──────────────┘  └──────────────┘  └──────────────┘
```

## Level 2: Detailed Process Flow

### 1.1 Create Backup Process

```
┌────────────────────────────────────────────────────────────┐
│                 1.1 Create Backup Process                  │
└────────────────────────────────────────────────────────────┘

Admin/Scheduler
      │
      │ 1. Команда backup
      ▼
┌──────────────────────────────────────────┐
│ 1.1.1 Validate Connections               │
│ - Проверка подключения к БД              │
│ - Проверка прав доступа                  │
│ - Проверка свободного места              │
└──────────┬───────────────────────────────┘
           │ 2. Connection OK
           ▼
┌──────────────────────────────────────────┐
│ 1.1.2 Execute Backup Command             │
│ - pg_dump для логического                │
│ - pg_basebackup для физического          │
│ - Копирование WAL файлов                 │
└──────────┬───────────────────────────────┘
           │ 3. Данные БД
           ▼
     PostgreSQL DB
           │ 4. Поток данных
           ▼
┌──────────────────────────────────────────┐
│ 1.1.3 Compress & Validate                │
│ - Сжатие backup файла                    │
│ - Проверка целостности (MD5/SHA)         │
│ - Создание метаданных                    │
└──────────┬───────────────────────────────┘
           │ 5. Backup file
           ▼
┌──────────────────────────────────────────┐
│ 1.1.4 Save to Storage                    │
│ - Сохранение в локальное хранилище       │
│ - Копирование на удаленное хранилище     │
│ - Обновление каталога backup             │
└──────────┬───────────────────────────────┘
           │ 6. Результат операции
           ▼
┌──────────────────────────────────────────┐
│ 1.1.5 Log & Notify                       │
│ - Логирование в систему                  │
│ - Отправка метрик в Prometheus           │
│ - Уведомление администратора             │
└──────────────────────────────────────────┘
```

### 1.3 Restore Backup Process

```
┌────────────────────────────────────────────────────────────┐
│                 1.3 Restore Backup Process                 │
└────────────────────────────────────────────────────────────┘

Admin
  │
  │ 1. Выбор backup file
  ▼
┌──────────────────────────────────────────┐
│ 1.3.1 Select Backup File                 │
│ - Просмотр доступных backup              │
│ - Проверка целостности файла             │
│ - Выбор точки восстановления             │
└──────────┬───────────────────────────────┘
           │ 2. Backup file path
           ▼
┌──────────────────────────────────────────┐
│ 1.3.2 Stop Applications                  │
│ - Остановка Flask приложения             │
│ - Закрытие всех подключений к БД         │
│ - Уведомление пользователей              │
└──────────┬───────────────────────────────┘
           │ 3. Apps stopped
           ▼
┌──────────────────────────────────────────┐
│ 1.3.3 Drop & Create Database             │
│ - DROP DATABASE (если существует)        │
│ - CREATE DATABASE                        │
│ - Настройка параметров БД                │
└──────────┬───────────────────────────────┘
           │ 4. Empty database
           ▼
┌──────────────────────────────────────────┐
│ 1.3.4 Restore Data                       │
│ - pg_restore из backup file              │
│ - Применение WAL файлов (PITR)           │
│ - Восстановление схемы и данных          │
└──────────┬───────────────────────────────┘
           │ 5. Данные восстановлены
           ▼
┌──────────────────────────────────────────┐
│ 1.3.5 Validate & Verify                  │
│ - Проверка целостности данных            │
│ - Подсчет записей в таблицах             │
│ - Проверка индексов и ограничений        │
└──────────┬───────────────────────────────┘
           │ 6. Validation OK
           ▼
┌──────────────────────────────────────────┐
│ 1.3.6 Start Applications                 │
│ - Запуск Flask приложения                │
│ - Проверка подключений                   │
│ - Уведомление о завершении               │
└──────────────────────────────────────────┘
```

### 1.4 Monitor Status Process

```
┌────────────────────────────────────────────────────────────┐
│              1.4 Monitoring Process (Continuous)           │
└────────────────────────────────────────────────────────────┘

Prometheus (каждые 15 секунд)
  │
  │ 1. Запрос метрик
  ▼
┌──────────────────────────────────────────┐
│ 1.4.1 Collect Metrics                    │
│ - Размер последнего backup               │
│ - Время выполнения backup                │
│ - Возраст последнего backup              │
│ - Свободное место на диске               │
└──────────┬───────────────────────────────┘
           │ 2. Данные метрик
           ▼
┌──────────────────────────────────────────┐
│ 1.4.2 Check Thresholds                   │
│ - Backup старше 25 часов? → Алерт        │
│ - Свободное место < 10%? → Алерт         │
│ - Backup failed? → Алерт                 │
└──────────┬───────────────────────────────┘
           │ 3. Алерты (если есть)
           ▼
┌──────────────────────────────────────────┐
│ 1.4.3 Send Alerts                        │
│ - AlertManager обрабатывает алерты       │
│ - Email уведомления администратору       │
│ - Slack/Telegram уведомления             │
└──────────┬───────────────────────────────┘
           │ 4. Метрики для визуализации
           ▼
┌──────────────────────────────────────────┐
│ 1.4.4 Visualize in Grafana               │
│ - Dashboard "Backup Status"              │
│ - Графики размера backup                 │
│ - Графики времени выполнения             │
│ - История backup операций                │
└──────────────────────────────────────────┘
```

## Data Stores

### D1: PostgreSQL Database
- **Содержимое:** Все данные приложения (products, customers, orders, etc.)
- **Операции:** Чтение (при backup), Запись (при restore)
- **Формат:** Бинарные данные PostgreSQL

### D2: File System Storage (Backup Directory)
- **Содержимое:** Backup файлы (.backup, .sql, .tar.gz)
- **Структура:**
  ```
  backups/
  ├── logical/        # pg_dump backups
  ├── physical/       # pg_basebackup backups
  └── wal_archive/    # WAL files
  ```
- **Операции:** Запись (при создании backup), Чтение (при restore)

### D3: Prometheus Time Series Database
- **Содержимое:** Метрики backup операций
- **Данные:**
  - `backup_last_success_time` - время последнего успешного backup
  - `backup_size_bytes` - размер backup файла
  - `backup_duration_seconds` - длительность backup
  - `disk_free_bytes` - свободное место
- **Retention:** 30 дней

### D4: PostgreSQL WAL Archive
- **Содержимое:** WAL (Write-Ahead Log) сегменты
- **Операции:** Запись (непрерывная), Чтение (при PITR)
- **Размер:** ~16MB на файл

## External Entities

### 1. Администратор БД
- **Действия:** 
  - Запускает backup/restore
  - Настраивает систему
  - Просматривает мониторинг
- **Интерфейсы:** 
  - Командная строка (BAT скрипты)
  - Веб-интерфейс управления
  - Grafana dashboards

### 2. Task Scheduler (Windows) / cron (Linux)
- **Действия:**
  - Автоматический запуск backup по расписанию
  - Очистка старых backup
- **Расписание:**
  - Логический backup: Ежедневно в 2:00 AM
  - Физический backup: Еженедельно в 3:00 AM воскресенье

### 3. Monitoring System (Prometheus + Grafana + AlertManager)
- **Действия:**
  - Сбор метрик backup
  - Визуализация статистики
  - Отправка алертов
- **Интервалы:**
  - Scrape interval: 15 секунд
  - Evaluation interval: 30 секунд

## Data Flows

| Flow ID | Описание | Источник | Назначение | Данные |
|---------|----------|----------|------------|--------|
| DF-01 | Команда backup | Admin | Create Backup Process | Параметры backup |
| DF-02 | Чтение данных БД | Create Backup | PostgreSQL | SQL queries |
| DF-03 | Поток данных БД | PostgreSQL | Create Backup | Database dump |
| DF-04 | Сохранение backup | Create Backup | File Storage | Backup file |
| DF-05 | Метрики backup | Create Backup | Prometheus | Метрики (размер, время) |
| DF-06 | Запрос restore | Admin | Restore Process | Путь к backup file |
| DF-07 | Чтение backup | Restore Process | File Storage | Backup file |
| DF-08 | Восстановление данных | Restore Process | PostgreSQL | SQL commands |
| DF-09 | WAL архивация | PostgreSQL | WAL Archive | WAL segments |
| DF-10 | Запрос метрик | Prometheus | PostgreSQL Exporter | Метрики БД |
| DF-11 | Алерты | AlertManager | Admin | Email/Slack уведомления |

## Process Timing

### Логический Backup (pg_dump)
- **Частота:** Ежедневно
- **Время выполнения:** 5-15 минут (зависит от размера БД)
- **Размер файла:** 10-50 MB (сжатый)
- **RPO:** 24 часа

### Физический Backup (pg_basebackup)
- **Частота:** Еженедельно
- **Время выполнения:** 10-30 минут
- **Размер файла:** 100-500 MB (с WAL)
- **RPO:** 1 неделя

### WAL Архивация
- **Частота:** Непрерывно (каждые 16MB)
- **Время архивации:** 1-5 секунд
- **RPO:** < 1 минута (с PITR)

### Restore Process
- **Логический restore:** 10-20 минут
- **Физический restore:** 15-30 минут
- **PITR:** 20-40 минут (включая применение WAL)
- **RTO:** < 2 часа

## Визуализация

Для создания графической диаграммы используйте:
- **Draw.io:** https://app.diagrams.net/
- **Lucidchart:** https://www.lucidchart.com/
- **Microsoft Visio**

Импортируйте текстовые диаграммы или создайте на основе описания выше.

