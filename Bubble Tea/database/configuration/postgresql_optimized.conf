# PostgreSQL Optimized Configuration for Bubble Tea Database
# Add or modify these settings in postgresql.conf
# Location: C:\Program Files\PostgreSQL\17\data\postgresql.conf
#
# After making changes, restart PostgreSQL:
# pg_ctl restart -D "C:\Program Files\PostgreSQL\17\data"

# ======================================
# CONNECTION AND AUTHENTICATION
# ======================================

# Maximum number of concurrent connections
max_connections = 100

# Superuser reserved connections
superuser_reserved_connections = 3

# ======================================
# MEMORY CONFIGURATION
# ======================================

# Shared memory for caching data (25% of RAM for dedicated server)
shared_buffers = 256MB          # For 1GB RAM, increase for more RAM

# Memory for query operations (per connection)
work_mem = 4MB                  # Increase for complex queries

# Memory for maintenance operations (VACUUM, CREATE INDEX)
maintenance_work_mem = 64MB

# Effective cache size (hint for query planner, ~50-75% of RAM)
effective_cache_size = 512MB

# ======================================
# WAL (Write-Ahead Logging)
# ======================================

wal_level = replica             # minimal, replica, or logical
fsync = on                      # Force synchronization (never turn off in production)
synchronous_commit = on         # on, off, local, remote_write, remote_apply
wal_sync_method = fsync         # fsync, fdatasync, open_sync

# WAL file settings
wal_buffers = 16MB
max_wal_size = 2GB
min_wal_size = 80MB
wal_keep_size = 1GB

# Checkpoints
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9
checkpoint_warning = 30s

# ======================================
# ARCHIVING AND REPLICATION
# ======================================

archive_mode = on
archive_command = 'copy "%p" "C:\\Users\\VICTUS\\Downloads\\Alisher Downloads\\Bubble Tea\\backups\\wal_archive\\%f"'
archive_timeout = 0             # Force archive after N seconds (0 = disabled)

# Replication
max_wal_senders = 3
max_replication_slots = 3
hot_standby = on
wal_sender_timeout = 60s

# ======================================
# QUERY PLANNING
# ======================================

# Enable parallel query execution
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_worker_processes = 8

# Cost-based optimizer parameters
random_page_cost = 4.0          # For HDD (use 1.1 for SSD)
effective_io_concurrency = 1    # For HDD (use 200 for SSD)
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# ======================================
# STATISTICS AND MONITORING
# ======================================

# Track query statistics
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on

# Activity tracking
track_activities = on
track_activity_query_size = 1024
track_counts = on
track_io_timing = on
track_functions = all

# ======================================
# AUTOVACUUM
# ======================================

autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.1
autovacuum_vacuum_cost_delay = 20ms

# ======================================
# LOGGING
# ======================================

# Where to log
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0600
log_truncate_on_rotation = off
log_rotation_age = 1d
log_rotation_size = 100MB

# What to log
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off
log_error_verbosity = default
log_hostname = off
log_lock_waits = on
log_statement = 'mod'           # none, ddl, mod, all
log_temp_files = 0              # Log temporary files larger than N KB (0 = all)

# Slow query logging
log_min_duration_statement = 1000  # Log queries slower than 1000ms

# ======================================
# ERROR REPORTING
# ======================================

client_min_messages = notice
log_min_messages = warning
log_min_error_statement = error

# ======================================
# LOCALE AND FORMATTING
# ======================================

datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'English_United States.1252'
lc_monetary = 'English_United States.1252'
lc_numeric = 'English_United States.1252'
lc_time = 'English_United States.1252'

default_text_search_config = 'pg_catalog.english'

# ======================================
# SECURITY
# ======================================

# Password encryption
password_encryption = scram-sha-256

# SSL (if certificates are available)
# ssl = on
# ssl_cert_file = 'server.crt'
# ssl_key_file = 'server.key'

# ======================================
# PERFORMANCE TUNING NOTES
# ======================================

# For SSD storage, adjust:
# - random_page_cost = 1.1
# - effective_io_concurrency = 200

# For dedicated database server with 4GB+ RAM:
# - shared_buffers = 1GB
# - effective_cache_size = 3GB
# - maintenance_work_mem = 256MB
# - work_mem = 16MB

# For high-concurrency applications:
# - max_connections = 200
# - shared_buffers = 512MB (keep relatively low)
# - work_mem = 2MB (lower to prevent memory exhaustion)

# ======================================
# RESTART REQUIRED
# ======================================
# After modifying these settings, restart PostgreSQL:
# sc stop postgresql-x64-17
# sc start postgresql-x64-17


