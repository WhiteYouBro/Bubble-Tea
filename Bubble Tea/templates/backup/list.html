{% extends "base.html" %}

{% block title %}Список бэкапов{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('backup.index') }}">Менеджер бэкапов</a></li>
            <li class="breadcrumb-item active">Все бэкапы</li>
        </ol>
    </nav>

    <div class="row mb-4">
        <div class="col-md-12">
            <h2><i class="bi bi-list-ul"></i> Все бэкапы</h2>
        </div>
    </div>

    <!-- Backup Type Tabs -->
    <div class="row mb-3">
        <div class="col-md-12">
            <ul class="nav nav-pills">
                <li class="nav-item">
                    <a class="nav-link {% if backup_type == 'logical' %}active{% endif %}"
                        href="{{ url_for('backup.backup_list', type='logical') }}">
                        <i class="bi bi-file-earmark-text"></i> Логические бэкапы
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if backup_type == 'physical' %}active{% endif %}"
                        href="{{ url_for('backup.backup_list', type='physical') }}">
                        <i class="bi bi-archive-fill"></i> Физические бэкапы
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div
                    class="card-header {% if backup_type == 'logical' %}bg-success{% else %}bg-info{% endif %} text-white">
                    <h5>
                        {% if backup_type == 'logical' %}
                        <i class="bi bi-file-earmark-text"></i> Логические бэкапы (pg_dump)
                        {% else %}
                        <i class="bi bi-archive-fill"></i> Физические бэкапы (pg_basebackup)
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if backups %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Файл</th>
                                    <th>Размер</th>
                                    <th>Создан</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for backup in backups %}
                                <tr>
                                    <td>
                                        <i
                                            class="bi {% if backup_type == 'logical' %}bi-file-earmark-zip{% else %}bi-file-earmark-zip-fill{% endif %}"></i>
                                        {{ backup.filename }}
                                    </td>
                                    <td>{{ backup.size }}</td>
                                    <td>{{ backup.modified }}</td>
                                    <td>
                                        {% if backup_type == 'logical' %}
                                        <a href="{{ url_for('backup.restore_backup') }}?file={{ backup.path }}"
                                            class="btn btn-sm btn-warning" title="Восстановить из этого бэкапа">
                                            <i class="bi bi-arrow-counterclockwise"></i> Восстановить
                                        </a>
                                        {% endif %}
                                        <button onclick="downloadBackup('{{ backup.path }}')"
                                            class="btn btn-sm btn-primary" title="Скачать бэкап">
                                            <i class="bi bi-download"></i> Скачать
                                        </button>
                                        <button onclick="deleteBackup('{{ backup.path }}', '{{ backup.filename }}')"
                                            class="btn btn-sm btn-danger" title="Удалить бэкап">
                                            <i class="bi bi-trash"></i> Удалить
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3">
                        <p class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Всего бэкапов: <strong>{{ backups|length }}</strong>
                        </p>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        {% if backup_type == 'logical' %}
                        Логических бэкапов не найдено. <a href="{{ url_for('backup.create_backup') }}">Создайте
                            бэкап</a>.
                        {% else %}
                        Физических бэкапов не найдено. <a href="{{ url_for('backup.create_backup') }}">Создайте
                            бэкап</a>.
                        {% endif %}
                    </div>
                    {% endif %}

                    <div class="mt-3">
                        <a href="{{ url_for('backup.index') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> К панели бэкапов
                        </a>
                        <a href="{{ url_for('backup.create_backup') }}" class="btn btn-success">
                            <i class="bi bi-plus-circle"></i> Создать новый бэкап
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Storage Info -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-folder"></i> Расположение хранилища</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Логические бэкапы</h6>
                            <p><code>D:\POProject\Bubble Tea\backups\logical\</code></p>
                            <ul>
                                <li>Формат: .backup (custom), .sql (plain)</li>
                                <li>Хранение: 30 дней</li>
                                <li>Автоочистка: Да</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Физические бэкапы</h6>
                            <p><code>D:\POProject\Bubble Tea\backups\physical\</code></p>
                            <ul>
                                <li>Формат: .tar.gz (сжатый)</li>
                                <li>Хранение: 4 недели</li>
                                <li>Автоочистка: Да</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function downloadBackup(path) {
        alert('Функция скачивания: Скоро будет доступна!\n\nПока что скопируйте файл вручную из:\n' + path);
    }

    function deleteBackup(path, filename) {
        if (confirm('Вы уверены, что хотите удалить бэкап:\n\n' + filename + '\n\nЭто действие нельзя отменить!')) {
            fetch('{{ url_for("backup.delete_backup", filename="PLACEHOLDER") }}'.replace('PLACEHOLDER', encodeURIComponent(path)), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    if (response.ok) {
                        alert('Бэкап успешно удалён!');
                        location.reload();
                    } else {
                        alert('Ошибка удаления бэкапа!');
                    }
                })
                .catch(error => {
                    alert('Ошибка: ' + error);
                });
        }
    }
</script>
{% endblock %}